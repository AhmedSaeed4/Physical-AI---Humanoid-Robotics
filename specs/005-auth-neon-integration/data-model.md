# Data Model: User Authentication and Persistent Chat History

**Feature**: 005-auth-neon-integration
**Date**: 2025-12-13

## Entities

### User
Represents a person using the system. Created during signup, updated via profile.

**Attributes**:
- `id` (TEXT, PRIMARY KEY): UUID string generated by Better Auth
- `email` (TEXT, UNIQUE, NOT NULL): User's email address for login
- `name` (TEXT, NOT NULL): User's full name
- `educationLevel` (TEXT): One of: "High School", "Undergraduate", "Graduate", "Professional"
- `programmingExperience` (TEXT): One of: "No Experience", "Beginner", "Intermediate", "Advanced"
- `roboticsBackground` (TEXT): One of: "No Experience", "Hobbyist", "Academic", "Professional"
- `softwareBackground` (TEXT): Optional free-text field for software experience details
- `hardwareBackground` (TEXT): Optional free-text field for hardware experience details
- `createdAt` (TIMESTAMP, DEFAULT NOW()): When user account was created

**Validation Rules**:
- Email must be valid format (validated by Better Auth)
- Password must be at least 8 characters (validated by Better Auth)
- Name must be non-empty string
- Learning preference fields must be one of allowed values (frontend validation)

**Relationships**:
- Has many `Session` records (one-to-many)
- Has many `ChatHistory` records (one-to-many)

### Session
Represents an active user login session. Created on login, deleted on logout or expiration.

**Attributes**:
- `id` (TEXT, PRIMARY KEY): Session ID generated by Better Auth
- `userId` (TEXT, FOREIGN KEY REFERENCES "user"("id") ON DELETE CASCADE): Reference to user
- `token` (TEXT): JWT token for API authentication
- `expiresAt` (TIMESTAMP, NOT NULL): When session becomes invalid
- `createdAt` (TIMESTAMP, DEFAULT NOW()): When session was created

**Validation Rules**:
- Token must be valid JWT signed with shared secret
- Expiration must be in future when created
- User must exist and be active

**Relationships**:
- Belongs to one `User` (many-to-one)

### ChatHistory
Represents a conversation between a user and the AI. Created for each message/response pair.

**Attributes**:
- `id` (SERIAL, PRIMARY KEY): Auto-incrementing integer
- `userId` (TEXT, FOREIGN KEY REFERENCES "user"("id") ON DELETE CASCADE, NOT NULL): Reference to user
- `message` (TEXT, NOT NULL): User's question/input to RAG chatbot
- `response` (TEXT, NOT NULL): AI response from Gemini/OpenAI Agents
- `selectedText` (TEXT, NULLABLE): Text selection context (optional)
- `createdAt` (TIMESTAMP, DEFAULT NOW(), NOT NULL): When chat message was created

**Validation Rules**:
- Message must be non-empty string
- Response must be non-empty string
- User must exist
- SelectedText can be null or non-empty string

**Relationships**:
- Belongs to one `User` (many-to-one)

## Database Schema

### PostgreSQL Tables (Neon)

```sql
-- User table (Better Auth managed with custom fields)
-- Note: Better Auth creates this table with additional columns
-- These are the custom columns we add for learning preferences
ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "educationLevel" TEXT;
ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "programmingExperience" TEXT;
ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "roboticsBackground" TEXT;
ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "softwareBackground" TEXT;
ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "hardwareBackground" TEXT;

-- Session table (Better Auth managed)
-- Created automatically by Better Auth

-- Chat History table (custom)
CREATE TABLE IF NOT EXISTS "chat_history" (
    "id" SERIAL PRIMARY KEY,
    "userId" TEXT NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
    "message" TEXT NOT NULL,
    "response" TEXT NOT NULL,
    "selectedText" TEXT,
    "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS "idx_chat_history_user" ON "chat_history" ("userId");
CREATE INDEX IF NOT EXISTS "idx_chat_history_created" ON "chat_history" ("createdAt" DESC);
CREATE INDEX IF NOT EXISTS "idx_chat_history_user_created" ON "chat_history" ("userId", "createdAt" DESC);
```

## State Transitions

### User Account Lifecycle
1. **Signup**: User enters email, password, name, learning preferences → `User` created with `createdAt`
2. **Login**: User enters credentials → `Session` created with `expiresAt` (24 hours)
3. **Profile Update**: User updates learning preferences → `User` fields updated
4. **Logout**: User explicitly logs out → `Session` deleted
5. **Session Expiry**: `expiresAt` passes → `Session` considered invalid (auto-cleanup by Better Auth)

### Chat History Lifecycle
1. **Message Sent**: User sends chat message → `ChatHistory` created with `message`, `userId`, `selectedText` (if any)
2. **Response Received**: AI generates response → `ChatHistory` updated with `response`
3. **History Retrieval**: User requests chat history → Query `ChatHistory` filtered by `userId`, ordered by `createdAt` DESC
4. **Account Deletion**: User deletes account → All `ChatHistory` records cascade deleted

## Data Validation Rules

### User Registration
- Email: Must be unique, valid format
- Password: Minimum 8 characters
- Name: Non-empty string, trimmed
- Learning Preferences: Must select one option from each category (frontend validation)

### Chat Messages
- Message: Non-empty string after trimming
- SelectedText: Optional, can be null or non-empty string
- User ID: Must reference existing user

### Session Management
- Token: Valid JWT format, not expired
- User: Must reference existing, active user

## Data Retention and Cleanup

### Retention Policy
- `User` records: Retained indefinitely unless deleted by user
- `Session` records: Auto-cleaned by Better Auth after expiration (default 24 hours)
- `ChatHistory` records: Retained indefinitely, cascade delete on user deletion

### Cleanup Operations
1. **Expired Sessions**: Better Auth automatically cleans expired sessions
2. **Orphaned Chat History**: Foreign key constraint ensures deletion when user deleted
3. **Database Maintenance**: Regular vacuum and analyze on Neon PostgreSQL

## Performance Considerations

### Index Strategy
1. `idx_chat_history_user`: For filtering chat history by user
2. `idx_chat_history_created`: For ordering chat history by time
3. `idx_chat_history_user_created`: Composite index for user-specific time-ordered queries

### Query Patterns
1. **User Chat History**: `WHERE userId = ? ORDER BY createdAt DESC LIMIT 50`
2. **User Lookup by Email**: `WHERE email = ?` (Better Auth index)
3. **Session Validation**: `WHERE token = ? AND expiresAt > NOW()` (Better Auth index)

### Scaling Considerations
- **Read-heavy**: Chat history queries are frequent, writes less frequent
- **Partitioning**: Could partition `chat_history` by `userId` hash if scale requires
- **Caching**: Frequently accessed user profiles could be cached in backend

## Security Considerations

### Data Protection
- **Passwords**: Hashed with bcrypt by Better Auth
- **Tokens**: JWT signed with strong secret, short expiration (24 hours)
- **Personal Data**: Email, name, learning preferences stored encrypted at rest (Neon default)

### Access Control
- **User Data**: Only accessible by owning user (user ID in JWT)
- **Chat History**: Filtered by user ID in all queries
- **Admin Access**: No admin endpoints in this feature scope

### Audit Trail
- `createdAt` timestamps on all records
- Chat history provides complete conversation record
- Better Auth logs authentication events